{"version":3,"file":"portfolio.js","sourceRoot":"","sources":["../../../lib/utils/portfolio.ts"],"names":[],"mappings":"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","sourcesContent":["import fetch from 'node-fetch'\nimport { networks } from 'ambire-common/dist/src/consts/networks'\nimport { Network } from 'ambire-common/dist/src/interfaces/network'\nimport { getRpcProvider } from 'ambire-common/dist/src/services/provider/getRpcProvider'\nimport { Portfolio } from 'ambire-common/dist/src/libs/portfolio'\nimport { llmMockProcess } from './llm/mockedAI'\nimport { simplePrompt } from './prompts'\nimport { EMPTY_PORTFOLIO_STRATEGIES } from './strategies'\nimport {\n    PortfolioForNetwork,\n    ProcessAddressProps,\n    AuraResponse_01,\n    NetworkPortfolioLibResponse\n} from '../types'\n\nexport async function getPortfolioForNetwork(\n    address: string,\n    networkId: string | bigint\n): Promise<NetworkPortfolioLibResponse> {\n    const network = networks.find((n: Network) => n.chainId === networkId || n.name === networkId)\n    if (!network) throw new Error(`Failed to find ${networkId} in configured networks`)\n\n    const provider = getRpcProvider(network.rpcUrls, network.chainId)\n    const portfolio = new Portfolio(\n        fetch,\n        provider,\n        network,\n        'https://relayer.ambire.com/velcro-v3'\n    )\n\n    return portfolio.get(address, { baseCurrency: 'usd' })\n}\n\nexport async function getPortfolioVelcroV3(address: string): Promise<PortfolioForNetwork[]> {\n    const output: PortfolioForNetwork[] = []\n\n    const responses = await Promise.all(\n        networks.map((network) => getPortfolioForNetwork(address, network.chainId))\n    )\n\n    for (const resp of responses) {\n        const tokens = resp.tokens\n            .filter((t) => t.amount > 0n)\n            .map((t) => {\n                const network = networks.find((n) => n.chainId === t.chainId) as Network\n                const balance = Number(t.amount) / Math.pow(10, t.decimals)\n                const priceUSD = (t.priceIn.find((p) => p.baseCurrency === 'usd') || { price: 0 })\n                    .price\n\n                return {\n                    symbol: t.symbol,\n                    balance,\n                    balanceUSD: balance * priceUSD,\n                    network: network.name,\n                    address: t.address\n                }\n            })\n\n        if (!tokens.length) {\n            continue\n        }\n\n        output.push({\n            network: tokens[0].network,\n            tokens\n        })\n    }\n\n    return output\n}\n\nexport const processAddress = async (\n    {\n        address,\n        getPortfolio,\n        makePrompt,\n        llmProcessor,\n        model,\n        llmOptionsOverride\n    }: ProcessAddressProps = {\n        address: '0x69bfD720Dd188B8BB04C4b4D24442D3c15576D10',\n        getPortfolio: getPortfolioVelcroV3,\n        makePrompt: simplePrompt,\n        llmProcessor: llmMockProcess\n    }\n): Promise<AuraResponse_01> => {\n    const portfolio = await getPortfolio(address)\n\n    if (!portfolio.length) {\n        return {\n            address,\n            portfolio,\n            strategies: [\n                {\n                    llm: {\n                        provider: 'local',\n                        model: 'local'\n                    },\n                    response: EMPTY_PORTFOLIO_STRATEGIES,\n                    inputTokens: 0,\n                    outputTokens: 0\n                }\n            ]\n        }\n    }\n\n    const prompt = await makePrompt({ portfolio })\n    const strategies = await llmProcessor({ prompt, model, llmOptionsOverride })\n\n    return {\n        address,\n        portfolio,\n        strategies: [strategies]\n    }\n}\n"]}